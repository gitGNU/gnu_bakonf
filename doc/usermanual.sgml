<!doctype linuxdoc system>
<linuxdoc><article>
    <titlepag>
      <title>bakonf - a configuration file backup tool</title>
      <author><name>Iustin Pop &lt;iusty@k1024.org&gt;</name></author>
      <date>$Id: usermanual.sgml,v 1.4 2002/12/18 23:20:12 iusty Exp $</date>
      <abstract>This document explains the concept and usage of bakonf, a system backup tool which backs up only the configuration files on a system.</abstract>
    </titlepag>
    <sect><heading>Introduction</heading>
      <p>Making backup is an important aspect of system administration. The techniques of backing up data are explained in any good document about system administration, and they won't be explained here again.</p>
      <p>However, bakonf comes into play into a particular part of the backups: the backing up of the system's configuration.</p>
      <p>The basic idea is that, after a fresh install of a package-based GNU/Linux system, for example RedHat 8.0 full install, you have &tilde;4.5GB of space used. However, only a <em>very</em> small part of this amount is holding important information, the other part being binaries, libraries and other kind of data which will never modify in normal usage. Only the configuration files are changing (of course, also the user data is changing, but we are talking about an empty system).</p>
      <p>If we classify the files existing on a Unix system, we have:
        <descrip>
          <tag>configuration data</tag>These are the target of bakonf; they are usually small text files, partly coming from packages, maybe edited by the administrator, partly created by him and not related (directly) to a package's file list. Size is (on the workstation I write this) &tilde;15MB.
          <tag>binaries, libraries, other system files</tag>These are mostly read-only; in a package based distribution, they came from the packages and are replaced when the package is upgraded. Size is (in our hypothetical rh8.0 full install) &tilde;4.5GB.
          <tag>user data</tag>These are emails, web pages, documents, etc. - this is important data, and needs to be backed up regularly. They also don't come from any package, and are not touched by the system. Size is undetermined.
          <tag>system variable data</tag>These are the files created and managed by the system, usually from the configuration files and other external variables. Examples: <tt>/var/lib/logrotate.status</tt>, <tt>/var/lib/slocate/slocate.db</tt>. These are not all critical files, some are needed to be included in a backup only for analysis purposes (e.g. if you reinstall your system or restore from backup, some files will have for sure other contents).
        </descrip>
        From all these, only the configuration data and the user data are absolutely required to recreate the system. The binaries can come from the installation source. The system managed data will be recreated by the system. And since the difference in size between the configuration and user data is so great in a typical system, I believe it deserves another backup method (besides the inclusion in standard backup procedures, which are, I repeat, <em>CRITICAL!</em>).
      </p>
    </sect>
    <sect>
      <heading>What does bakonf do?</heading>
      <p>You can regard bakonf as a rescue archive creator. It creates an archive of <em>modified</em> configuration files. It uses the system's packaging tool to see which files have been changed since their installation or which files do not come from any package, and creates an archive out of them. Also, it stored in the generated archives some other information I thought is important and is not found in the filesystem, like package list, version of the running kernel. In the future I'll add some more.</p>
      <sect1>
        <heading>What can I use bakonf for?</heading>
        <p>At least for:
           <itemize>
            <item>Configuration rollback. Since the archives are small, you can keep many versions, but unlike in differential backup, here one archive contains all the needed data.</item>
            <item>Configuration cloning. You can take a bakonf-generated archive from one system to another and 'clone' as much of the settings as you want.</item>
            <item>Quick restore of a server in case of catastrofic harddisk failure. Just reinstall the OS and put the config files back.</item>
          </itemize>
      </sect1>
      <sect1>
        <heading>Where is bakonf usable?</heading>
<p>At the moment, only on a distribution which uses rpm 4.1 and has the rpm-python bindings installed. It has been designed to handle any Unix system is full package based, and could be used for any Unix distribution (but in this case it would make a full backup of the configuration files everytime).</p>
      </sect1>
    </sect>
    <sect>
      <heading>Configuration</heading>
      <p><bf>Note:</bf> older bakonf versions (&lt; 0.5) had an entirely different config file. If you upgraded, be sure to forward you changes to the new config files.</p>
      <p>bakonf uses a main configuration file <tt>/etc/bakonf/bakonf.xml</tt>, which does some standard settings and tells bakonf what other files to include. These additional files are usually locate in <tt>/etc/bakonf/sources</tt> and tell bakonf how to handle some special cases.</p>
      <sect1>
        <heading>Configuration language</heading>
        <p>The configuration file is written in XML, and must have the document tag <em>bakonf</em>.</p>
        <p>The file can contain the following tags:
          <descrip>
            <tag>&lt;include path="<tt/BAKONF_CONFIGFILE_PATTERN/"/&gt;</tag>tell bakonf to also parse any files which match the given shell pattern. These are files which modify bakonf's own behavior, and are usually located in /etc/bakonf/sources. These are not directories to be backed up! (Altough, if modified, they will be, since are located under /etc usually).
            <tag>&lt;filesystem&gt;</tag>Starts declarations about files to be backed up, and can contain:
              <descrip>
                <tag>&lt;scan path="<tt/PATTERN/"/&gt;</tag>tell bakonf to add any file or directory which matched shell pattern <tt/PATTERN/ to its include list. These can be files or directories. Bakonf will descend directories, but will not <em>follow</em> symbolic links! The symlinks are considered configuration items also, so they will be backeup up themselves.
                <tag>&lt;noscan regex="<tt/REGEXP/"/&gt;</tag>tell bakonf to ignore any file or directory which matches the regular expression REGEXP from analysing.
              </descrip>
            <tag>&lt;meta&gt;</tag>Starts declarations about metainformations to be included in the archive, and can contain:
              <descrip>
                <tag>&lt;storeoutput command="<tt/SHELL COMMAND/" destination="<tt/PATH IN ARCHIVE/"/&gt;</tag>Tells bakonf to execute the given <tt/SHELL COMMAND/ and include its output in a file named <tt>meta/PATH IN ARCHIVE</tt> in the created archive. For example, the element: <tt>&lt;storeoutput command="cat /proc/version" destination="proc/version"/&gt;</tt> will create a file in the archive with the name <tt>meta/proc/version</tt> which will contain the <tt>/proc/version</tt> file.
              </descrip>
          </descrip>
          The order of precedence for scan/noscan is:
<itemize>
            <item>bakonf will start scanning all items defined with scan</item>
            <item>if at any point in the filesystem scan, the current file/directory mathes any one of noscan REGEXPs, the scan will ignore it. For directories, that means ignoring all the files they contain, so please be careful about it.</item>
          </itemize>
        <p>Using these, you can select where you want bakonf to look for files for archiving. The default config file includes <tt>/etc</tt>, <tt>/usr/etc</tt>, <tt>/usr/local/etc</tt> and some others (look in <tt>/etc/bakonf</tt> after installing).
        <p>Example main configuration file (the file included in the distribution):
      <code>
&lt;bakonf&gt;
&lt;!-- 
     Bakonf main configuration file. Tune to your system.
     See also the files in the sources subdirectory (included by default)
--&gt;
&lt;filesystem&gt;
    &lt;!-- Standard directories --&gt;
    &lt;scan path="/etc" /&gt;
    &lt;scan path="/usr/etc" /&gt;
    &lt;scan path="/usr/local/etc" /&gt;
    &lt;scan path="/var/lib/alternatives" /&gt;
&lt;/filesystem&gt;
&lt;!-- Include by default the other configuration files --&gt;
&lt;include path="/etc/bakonf/sources/*.xml" /&gt;
&lt;/bakonf&gt;
</code>
Example proc configuration file (included in the distribution):
<code>
&lt;bakonf&gt;
&lt;!--
     File which contains hardware related informations, mostly
     extracted from the /proc filesystem
--&gt;
&lt;meta&gt;
&lt;!-- Proc values --&gt;
&lt;storeoutput command="cat /proc/version" destination="proc/version"/&gt;
&lt;storeoutput command="cat /proc/dma" destination="proc/dma"/&gt;
&lt;storeoutput command="cat /proc/interrupts" destination="proc/interrupts"/&gt;
&lt;storeoutput command="cat /proc/ioports" destination="proc/ioports"/&gt;
&lt;storeoutput command="cat /proc/iomem" destination="proc/iomem"/&gt;
&lt;storeoutput command="cat /proc/cpuinfo" destination="proc/cpuinfo"/&gt;
&lt;storeoutput command="cat /proc/partitions" destination="proc/partitions"/&gt;
&lt;!-- Also hardware information --&gt;
&lt;storeoutput command="/sbin/lspci -vv" destination="lspci.txt"/&gt;
&lt;storeoutput command="/sbin/lsusb -vv" destination="lsusb.txt"/&gt;
&lt;/meta&gt;
&lt;/bakonf&gt;
</code>
</p>
      </sect1>
      <sect1>
        <heading>File list</heading>
        <p>bakonf is composed of:
        <descrip>
            <tag><tt>/etc/bakonf/bakonf.xml</tt></tag>Main configuration file.
            <tag><tt>/etc/bakonf/sources/*.xml</tt></tag>Configuration files for special cases (config files outside of etc dirs).
            <tag><tt>/usr/sbin/bakonf.py</tt></tag>Main program
            <tag><tt>/etc/cron.d/bakonf</tt></tag>Cron file, by default it does not run bakonf, you must uncomment a line to run it.
            <tag><tt>/var/lib/bakonf/archives</tt></tag>Default directory for configuration file archives.
          </descrip>
        <bf>Note:</bf>You must decide yourself what to do with the configuration archives after bakonf creates them!
      </sect1>
    </sect>
    <sect>
      <heading>Using bakonf</heading>
      <sect1>
        <heading>Backup phase</heading>
      <p>To use bakonf, choose to either:
        <itemize>
          <item>run it manually, when you want</item>
          <item>use the provided cron script to run it autmatically, or create your own</item>
        </itemize>
</p>
      <p>In any case, you have to do something with the generated archives. Write the to floppy, tape, CD, other machine, but don't just ignore them, you defeat the purpose of bakonf.</p>
      </sect1>
      <sect1>
        <heading>Restore phase</heading>
        <sect2>
          <heading>Configuration rollback</heading>
          <p>In this case, just make sure you have the bakonf-generated archive near the date in the past you are interested in. If so:
            <enum>
              <item>compare the actual package list with the one recorded by bakonf when it created the archive</item>
              <item>install/remove packages as needed</item>
              <item>copy the configuration files for the services you want to rollback over the current files</item>
            </enum>
           </p>
        </sect2>
        <sect2>
          <heading>Complete system restoration</heading>
          <p>If you had a catastrophical failure, you should follow these steps:
             <enum>
              <item>Reinstall the operating system on a clean machine. Use the given information in the <tt>/meta</tt> directory in the archive to achieve an as close as possible configuration as the old system (e.g. partition layout, packages installed, etc.)</item>
              <item>Copy all the files in the archive in the filesystem, overwriting the defaults from the packages.</item>
            </enum>
          </p>
        </sect2>
      </sect1>
    </sect>
  </article>
</linuxdoc>
  
